{
    
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "virtualNetworkName": {
        "type": "string",
        "defaultValue": "First_ARM_VNet",
        "metadata": {
          "description": "This is your Virtual Network"
        }
      },
      "addressPrefix": {
        "type": "string",
        "defaultValue": "10.0.0.0/16",
        "metadata": {
          "description": "The CIDR address space for your Virtual Network in Azure"
        }
      },
      "AppGwSubnetPrefix": {
        "type": "string",
        "defaultValue": "10.0.0.0/24",
        "metadata": {
          "description": "This is CIDR prefix for the FrontEnd Subnet"
        }
      },
      "BackendSubnetPrefix": {
        "type": "string",
        "defaultValue": "10.0.1.0/24",
        "metadata": {
          "description": "This is CIDR prefix for the Application Subnet"
        }
      },
      "DMZSubnetPrefix": {
        "type": "string",
        "defaultValue": "10.0.2.0/24",
        "metadata": {
          "description": "This is CIDR prefix for the Database Subnet"
        }
      },
      "FrontendSubnetPrefix": {
        "type": "string",
        "defaultValue": "10.0.2.0/24",
        "metadata": {
          "description": "This is CIDR prefix for the Database Subnet"
        }
      },
      "AppGwNSGName": {
        "type": "string",
        "defaultValue": "FE_NSG",
        "metadata": {
          "description": "This is name of the networkSecurityGroup that will be assigned to FrontEnd Subnet"
        }
      },
      "BackendNSGName": {
        "type": "string",
        "defaultValue": "FE_NSG",
        "metadata": {
          "description": "This is name of the networkSecurityGroup that will be assigned to FrontEnd Subnet"
        }
      },
      "DMZNSGName": {
        "type": "string",
        "defaultValue": "App_NSG",
        "metadata": {
          "description": "This is name of the networkSecurityGroup that will be assigned to Application Subnet"
        }
      },
      "FrontEndNSGName": {
        "type": "string",
        "defaultValue": "DB_NSG",
        "metadata": {
          "description": "This is name of the networkSecurityGroup that will be assigned to Database Subnet"
        }
      }
    },
    "variables" : {
      "VNETPeerDestID" : "",
      "VNETPeerName" : "",
      "RemoteVNETRG" : "",
      "RemoteVNETSubID" : "",
      "CurrentVNET" : "[resourceID('Microsoft.Network/virtualNetworks',parameters('virtualNetworkName'))]"
    },
    "resources": [
      {
        "apiVersion": "2017-10-01",
        "type": "Microsoft.Network/networkSecurityGroups",
        "name": "[parameters('AppGwNSGName')]",
        "location": "[resourceGroup().location]",
        "properties": {
          "securityRules": []
        }
      },
      {
        "apiVersion": "2017-10-01",
        "type": "Microsoft.Network/networkSecurityGroups",
        "name": "[parameters('BackendNSGName')]",
        "location": "[resourceGroup().location]",
        "properties": {
          "securityRules": []
        }
      },
      {
        "apiVersion": "2017-10-01",
        "type": "Microsoft.Network/networkSecurityGroups",
        "name": "[parameters('DMZNSGName')]",
        "location": "[resourceGroup().location]",
        "properties": {
          "securityRules": []
        }
      },
      {
        "apiVersion": "2017-10-01",
        "type": "Microsoft.Network/networkSecurityGroups",
        "name": "[parameters('FrontEndNSGName')]",
        "location": "[resourceGroup().location]",
        "properties": {
          "securityRules": []
        }
      },
      {
        "apiVersion": "2017-10-01",
        "type": "Microsoft.Network/virtualNetworks",
        "name": "[parameters('virtualNetworkName')]",
        "location": "[resourceGroup().location]",
        "dependsOn": [
          "[concat('Microsoft.Network/networkSecurityGroups/', parameters('AppGwNSGName'))]",
          "[concat('Microsoft.Network/networkSecurityGroups/', parameters('BackendNSGName'))]",
          "[concat('Microsoft.Network/networkSecurityGroups/', parameters('DMZNSGName'))]",
          "[concat('Microsoft.Network/networkSecurityGroups/', parameters('FrontEndNSGName'))]"
        ],
        "properties": {
          "addressSpace": {
            "addressPrefixes": [
              "[parameters('addressPrefix')]"
            ]
          },
          "dhcpOptions": {
            "dnsServers": [
              "",
              ""
            ]
          },
          "subnets": [
            {
              "name": "AppGW",
              "properties": {
                "addressPrefix": "[parameters('AppGwSubnetPrefix')]",
                "networkSecurityGroup": {
                  "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('AppGwNSGName'))]"
                }
              }
            },
            {
              "name": "BackEnd",
              "properties": {
                "addressPrefix": "[parameters('BackendSubnetPrefix')]",
                "networkSecurityGroup": {
                  "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('BackendNSGName'))]"
                }
              }
            },
            {
              "name": "FrontEnd",
              "properties": {
                "addressPrefix": "[parameters('FrontendSubnetPrefix')]",
                "networkSecurityGroup": {
                  "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('FrontEndNSGName'))]"
                }
              }
            },
            {
              "name": "DMZ",
              "properties": {
                "addressPrefix": "[parameters('DMZSubnetPrefix')]",
                "networkSecurityGroup": {
                  "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('DMZNSGName'))]"
                }
              }
            }
          ],
          "enableDdosProtection": false,
          "enableVmProtection": false
        }
      },
      {
        "apiVersion": "2017-10-01",
        "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
        "name": "[concat(parameters('virtualNetworkName'),'/',variables('VNETPeerName'))]",
        "location": "[resourceGroup().location]",
        "properties": {
          "allowVirtualNetworkAccess": true,
          "allowForwardedTraffic": true,
          "allowGatewayTransit": false,
          "useRemoteGateways": true,
          "remoteVirtualNetwork": {
            "id": "[variables('VNETPeerDestID')]"
          }
        }
      },
      {
        "name": "MCTPRODPeeringDeployment",
        "type": "Microsoft.Resources/deployments",
        "apiVersion": "2017-05-10",
        "resourceGroup": "[variables('RemoteVNETRG')]",
        "subscriptionId": "[variables('RemoteVNETSubID')]",
        "properties": {
          "template": {
            "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
            "contentVersion": "1.0.0.0",
            "resources": [
                {
                  "apiVersion": "2017-10-01",
                  "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                  "name": "USAZE-MCT-PRD-VNET/LinkToTestNetwork",
                  "location": "[resourceGroup().location]",
                  "properties": {
                    "allowVirtualNetworkAccess": true,
                    "allowForwardedTraffic": true,
                    "allowGatewayTransit": true,
                    "useRemoteGateways": false,
                    "remoteVirtualNetwork": {
                      "id": "[variables('CurrentVNET')]"
                    }
                  }
                }
          
          
              ]
  
          }, 
          "mode": "Incremental"
          }
        }
      
        ]
  
    }